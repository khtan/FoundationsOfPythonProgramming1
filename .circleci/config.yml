version: 2.1
orbs:
   win: circleci/windows@2.2.0
jobs:
  buildtest_linux:
    docker:
      - image: cimg/python:3.8
    steps:
      - checkout
      - run:
          name: Install Pytest
          command: pip install --user pytest pytest-mock requests
      - run:
          name: Check Pytest
          command: ./manage.py test
      - run:
          name: Run Pytest unit tests
          working_directory: python
          command: |
            mkdir pytest-results
            pytest tests --junitxml=pytest-results/junit.xml
      - store_test_results:
           path : python/pytest-results
      - store_artifacts:
           path : python/pytest-results
  buildtest_windows:
    executor:
        name: win/default
        shell: bash.exe
    steps:
      - checkout
      - run:
          name : Install project dependencies
          working_directory: csharp
          command: dotnet.exe restore
      - run:
          name : Run Xunit unit tests
          working_directory: csharp
          command: |
            dotnet.exe test XUnitTests/XUnitTests.csproj -v n --logger "junit;LogFilePath=csharp-results/csharp-unit-test.xml"
      - store_test_results:
           path : csharp/XUnitTests/csharp-results

workflows: # run windows before linux sequentially
  version: 2.1
  build_all_platforms:
     jobs:
       - buildtest_windows
       - buildtest_linux:
           requires:
             - buildtest_windows

